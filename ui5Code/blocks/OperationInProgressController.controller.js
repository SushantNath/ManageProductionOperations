/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/i2d/mpe/lib/commons1/utils/formatter","sap/ui/core/format/NumberFormat","sap/i2d/mpe/lib/popovers1/fragments/MaterialController","sap/i2d/mpe/lib/popovers1/fragments/ProductionOrderController","sap/i2d/mpe/lib/popovers1/fragments/ProductionOrderOperationsController","sap/ui/model/resource/ResourceModel","sap/i2d/mpe/lib/commons1/utils/util","sap/i2d/mpe/lib/commons1/fragments/OrderOperationStatus","sap/i2d/mpe/lib/commons1/utils/NavHelper","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/ui/model/json/JSONModel"],function(C,F,N,M,P,O,R,r,a,b,c,d,J){"use strict";return C.extend("i2d.mpe.operations.manages2.blocks.OperationInProgressController",{formatter:F,reuseUtil:r,onInit:function(){var i=this.loadI18NFile();this.getView().setModel(i,"common_i18n");this.oMaterialPop=new M();this.oProductionOrderPop=new P();this.oOperationPop=new O();this.getView().byId("idOperationInProgressTable").setIgnoreFromPersonalisation("ManufacturingOrder,ManufacturingOrderSequence,ManufacturingOrderOperation,Material,MaterialName,MfgOrderOperationReadyQuantity,MfgOrderOperationText,OpPlannedTotalQuantity,OperationUnit,OpLtstSchedldExecStrtDte,OpLtstSchedldExecEndDte,OpActualExecutionStartDate,OpActualExecutionEndDate,OpPlannedScrapQuantity,OperationYieldDeviationQty,OperationHasScrapQualityIssue,OpActyConfIsSFIBased,ExecutionEndLatenessInHours,ExecutionEndLatenessInMinutes,ExecutionStartLatenessInHours,ExecutionStartLatenessInMins,OperationHasMissingComponents,OperationHasProductionHold,OperationHasScrapQualityIssue,OperationIsClosed,OperationIsConfirmed,OperationIsCreated,OperationIsDeleted,OperationIsDelivered,OperationIsPartiallyConfirmed,OperationIsPartiallyDelivered,OperationIsPrinted,OperationIsReleased,OperationIsScheduled,OperationIsTechlyCompleted,OperationStartDeviationDays,OperationStatusInternalID,OpExecutionCompletedQuantity,OpHasAssgdProdnRsceTools,PlannedEndDateDvtnInDays,WorkCenterTypeCode,MfgOrderOperationReadyQuantity,WorkCenterInternalID,OpLtstSchedldExecStrtTme,OpLtstSchedldExecStrtDte,OpLtstSchedldExecEndDte,OpLtstSchedldExecEndTme,OperationActivityNetwork,OpActyNtwkVersionCounter,SupplyArea,OpTotalConfirmedScrapQty,OperationExecutionEndIsLate,OpActyNtwkInstance");var v;v=new J({allIssuesCount:0,showOnlyHoldIssues:false,showOnlyRdyToFnshIssues:false});this._searchField=this.getView().byId("idOptInProgressSearchField");this.getView().setModel(v,"idOperationInProgressTable");this.oViewModel=this.getView().getModel("idOperationInProgressTable");this._bButtonItemClicked=true;},loadI18NFile:function(){var i=jQuery.sap.getModulePath("sap.i2d.mpe.lib.commons1")+"/"+"i18n/i18n.properties";return new R({bundleUrl:i});},getTableCount:function(w,p,q){var e="/C_Manageoperations/$count";var B=this.getView().getBindingContext();var s;if(B){s=B.getPath();}else{s="/"+this.getView().getModel("DetailModel").getData().orderId;}var o=this.getView().getModel().getContext(s).getObject();var f=this.getView().getModel("DetailModel").getData();if(!o&&o===undefined&&f.selectedOrderData){o=f.selectedOrderData;}var g=this.formatter.getFeatureAvailability(o.MfgFeatureIsActiveInAnyPlant);var S=new sap.ui.model.Filter({and:false,filters:[new d("ManufacturingOrder",c.Contains,q),new d("Material",c.Contains,q),new d("MaterialName",c.Contains,q)]});var h=new sap.ui.model.Filter({and:false,filters:[new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,4),new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,6)]});var i=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("OperationHasProductionHold",sap.ui.model.FilterOperator.EQ,false)]});var j=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("OperationHasProductionHold",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("OperationHasMissingComponents",sap.ui.model.FilterOperator.NE,'X')]});var k=new sap.ui.model.Filter({and:true,filters:[h,i]});var l=new sap.ui.model.Filter({and:true,filters:[h,j]});var W=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("WorkCenterInternalID",sap.ui.model.FilterOperator.EQ,w),new sap.ui.model.Filter("ProductionPlant",sap.ui.model.FilterOperator.EQ,p)]});var m={filters:[new sap.ui.model.Filter({and:true,filters:[h,W,S]})],success:function(D){var v=new J({oDataCount3:D});this.getView().setModel(v,"view2");var T=this.getView().byId("idOperationInProgressFirstTable");T.setBusy(false);}.bind(this),error:function(E){sap.m.MessageBox.error(E);}};this.getView().getModel().read(e,m);if(g){var n={filters:[new sap.ui.model.Filter({and:true,filters:[k,W,S]})],success:function(D){var v=new J({oDataCount:D});this.getView().setModel(v,"view1");var T=this.getView().byId("idOperationInProgressFirstTable");T.setBusy(false);}.bind(this),error:function(E){sap.m.MessageBox.error(E);}};this.getView().getModel().read(e,n);}var t={filters:[new sap.ui.model.Filter({and:true,filters:[l,W,S]})],success:function(D){var v=new J({oDataCount2:D});this.getView().setModel(v,"view");var T=this.getView().byId("idOperationInProgressFirstTable");T.setBusy(false);}.bind(this),error:function(E){sap.m.MessageBox.error(E);}};this.getView().getModel().read(e,t);},handleBeforeRebindTable:function(e){var B=e.getSource().getBindingContext();var o=e.getParameter("bindingParams");o.sorter=[new sap.ui.model.Sorter("OpActualExecutionStartDate",true)];var f=new sap.ui.model.Filter({and:false,filters:[new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,4),new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,6)]});if(this.returnIssueStatusValue(e)===true){var i=new sap.ui.model.Filter({and:false,filters:[new sap.ui.model.Filter("OperationHasProductionHold",sap.ui.model.FilterOperator.EQ,false)]});}else if(this.returnAllRdyToFnshStatusValue(e)===true){var g=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("OperationHasProductionHold",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("OperationHasMissingComponents",sap.ui.model.FilterOperator.NE,'X')]});}var h,p,j;if(B){p=B.getPath();j=e.getSource().getModel().getContext(p).getObject();h=[new sap.ui.model.Filter("WorkCenterInternalID",sap.ui.model.FilterOperator.EQ,j.WorkCenterInternalID),new sap.ui.model.Filter("ProductionPlant",sap.ui.model.FilterOperator.EQ,j.ProductionPlant)];}else{p="/"+e.getSource().getModel("DetailModel").getData().orderId;j=e.getSource().getModel().getContext(p).getObject();if(j){h=[new sap.ui.model.Filter("WorkCenterInternalID",sap.ui.model.FilterOperator.EQ,j.WorkCenterInternalID),new sap.ui.model.Filter("ProductionPlant",sap.ui.model.FilterOperator.EQ,j.ProductionPlant)];}}var k=e.getSource().getModel("DetailModel").getData();if(!j&&j===undefined&&k.selectedOrderData){h=[new sap.ui.model.Filter("WorkCenterInternalID",sap.ui.model.FilterOperator.EQ,k.selectedOrderData.WorkCenterInternalID),new sap.ui.model.Filter("ProductionPlant",sap.ui.model.FilterOperator.EQ,k.selectedOrderData.ProductionPlant)];j=k.selectedOrderData;}var w=new sap.ui.model.Filter({and:true,filters:h});var q=this._searchField.getValue("");var s=new sap.ui.model.Filter({and:false,filters:[new d("ManufacturingOrder",c.Contains,q),new d("Material",c.Contains,q),new d("MaterialName",c.Contains,q)]});var W;if(this.returnIssueStatusValue(e)===true){W=new sap.ui.model.Filter({and:true,filters:[f,w,i,s]});o.filters.push(W);}else if(this.returnAllRdyToFnshStatusValue(e)===true){W=new sap.ui.model.Filter({and:true,filters:[f,w,g,s]});o.filters.push(W);}else{W=new sap.ui.model.Filter({and:true,filters:[f,w,s]});o.filters.push(W);}if(this._bButtonItemClicked===true){}else{this._bButtonItemClicked=true;}},handleCoverageChartPress:function(e){var o=e.getSource().getBindingContext();var m=o.getModel();var s=m.getContext(o.getPath()).getObject();var q=[];var Q=[];var f=[];var g=s.OpTotalConfirmedYieldQty;var u=s.OperationUnit;if(g!==undefined&&g>=0){g=N.getFloatInstance({}).format(g);q.push(g);Q.push("grey");var p=this.getView().getModel("common_i18n").getResourceBundle().getText("processed");f.push(p);}var h=s.MfgOrderOperationReadyQuantity;var i=this.getView().getModel("common_i18n").getResourceBundle().getText("ready");if(h!==undefined&&h>=0){h=N.getFloatInstance({}).format(h);q.push(h);Q.push("green");f.push(i);}else if((h!==undefined&&h<0)){h=N.getFloatInstance({}).format(0);q.push(h);Q.push("green");f.push(i);}var j=s.MfgOrderOperationNotReadyQty;var n=this.getView().getModel("common_i18n").getResourceBundle().getText("notReady");if(j!==undefined&&j>=0){j=N.getFloatInstance({}).format(j);q.push(j);Q.push("orange");f.push(n);}else if((j!==undefined&&j<0)){j=N.getFloatInstance({}).format(0);q.push(j);Q.push("orange");f.push(n);}r.openStackedBarChartPopover2(this,e,q,Q,f,u);},handleIconPress:function(e){var o=e.getSource().getColor();if(o==="#d9d9d9"){return"";}else{var w=true;r.openIssuePopOver(e,this,w);}},handleMaterialLinkPress:function(e){var o=e.getSource().getBindingContext();var m=o.getModel();var p=m.getProperty("ProductionPlant",o);var s=m.getProperty("Material",o);this.oMaterialPop.openMaterialPopOver(e,this,s,p);},handleOrderNumberPress:function(e){var s=e.getSource();var p=s.getBindingContext().sPath;var o=s.getModel().getProperty(p);var m=o.ManufacturingOrder||o.MRPElement;this.oProductionOrderPop.openProdOrdPopOver(e,this,m);},handleOperationPress:function(e){var o=e.getSource().getBindingContext();var m=o.getModel();var s=m.getProperty("OrderInternalID",o);var f=m.getProperty("OrderOperationInternalID",o);this.oOperationPop.openOperationsPopOver(e,this,s,f);},handleOperationSelect:function(e){var p=e.getParameter("listItem").getBindingContextPath();var o=r.getObjectPageRefrence();if(o&&o.getRouter()){var f=o.getRouter();var A=o.iAppState;f.navTo("object",{operationId:p.substr(1),iAppState:A},false);}else{var g=sap.ushell.Container.getService("CrossApplicationNavigation");g.toExternal({target:{shellHash:"#ManufacturingOrderOperation-manage&/ManageOperations"+p}});}},_filter:function(){var f=null;if(this._oGlobalFilter){f=this._oGlobalFilter;}this.getView().byId("idOperationInProgressFirstTable").getBinding("items").filter(f,"Application");},handleOrdersSearch:function(e){var q=e.getParameter("query");this._oGlobalFilter=null;this.getSearchTableCount(q,e.getSource().getBindingContext(),this.getView().getModel());var p=e.getSource().getBindingContext().getPath();var o=this.getView().getModel().getContext(p).getObject();},getSearchTableCount:function(q,B,D){var m=new sap.ui.model.Filter({and:false,filters:[new d("ManufacturingOrder",c.Contains,q),new d("Material",c.Contains,q),new d("MaterialName",c.Contains,q)]});var f=new sap.ui.model.Filter({and:false,filters:[new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,4),new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,6)]});var o=new sap.ui.model.Filter({and:false,filters:[new sap.ui.model.Filter("OperationHasProductionHold",sap.ui.model.FilterOperator.EQ,false)]});var e=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("OperationHasProductionHold",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("OperationHasMissingComponents",sap.ui.model.FilterOperator.NE,'X')]});var p=B.getPath();var g=D.getContext(p).getObject();var w=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("WorkCenterInternalID",sap.ui.model.FilterOperator.EQ,g.WorkCenterInternalID),new sap.ui.model.Filter("ProductionPlant",sap.ui.model.FilterOperator.EQ,g.ProductionPlant)]});if(this.returnIssueStatusValue()===true){this._oGlobalFilter=new d({and:true,filters:[f,w,o,m]});this._filter();}else if(this.returnAllRdyToFnshStatusValue()===true){this._oGlobalFilter=new d({and:true,filters:[f,w,e,m]});this._filter();}else{this._oGlobalFilter=new d({and:true,filters:[f,w,m]});this._filter();}},handleStatusLinkPress:function(e){a.openStatusPopOver(e,this);},handleItemSelect:function(e){var p=e.getParameter("listItem").getBindingContextPath();var t=this.getView().byId("idOperationInProgressFirstTable");t.setBusy(true);var m=this.getView().getModel();var o=m.getProperty(p);var s=o.ManufacturingOrder;var f=o.ManufacturingOrderOperation;var g=o.OperationStatusInternalID;var h=this.getView().getModel("common_i18n").getResourceBundle().getText("messageBoxHeader");var i=this.getView().getModel("common_i18n").getResourceBundle().getText("messageBoxMessage");if(this.getView().getModel("objectView").oData.workCenterQueue){if(g==="01"){sap.m.MessageBox.information(i,{title:h});t.setBusy(false);}else{b.navFromOrderEntry(this,s,f,t);}}else{this.handleOperationSelect(e);}},onDataReceived:function(e){var f=e.getParameters().getParameters().data.results;var l=f.length;if(this.returnIssueStatusValue(e)===false&&this.returnAllRdyToFnshStatusValue(e)===false){this.getView().getModel("idOperationInProgressTable").setProperty("/allIssuesCount",this.getallOperationsCount(e));}this.getView().getModel("idOperationInProgressTable").setProperty("/holdIssueCount",this.getOnlyIssuesCount(e));},handleOperationsBtnPress:function(){this.goAllOpTable=this.getView().byId("idOperationInProgressTable");this.goAllOpTable.rebindTable();},returnIssueStatusValue:function(e){var i=this.getView().getModel("idOperationInProgressTable");var I=i.getData();return I.showOnlyHoldIssues;},returnAllRdyToFnshStatusValue:function(e){var i=this.getView().getModel("idOperationInProgressTable");var I=i.getData();return I.showOnlyRdyToFnshIssues;},getallOperationsCount:function(e){},showAllOperations:function(e){this.getView().getModel("idOperationInProgressTable").setProperty("/showOnlyHoldIssues",false);this.getView().getModel("idOperationInProgressTable").setProperty("/showOnlyRdyToFnshIssues",false);this._bButtonItemClicked=false;this.getSearchTableCount(this._searchField.getValue(),this.getView().getBindingContext(),this.getView().getModel());},getOnlyIssuesCount:function(e){},showAllIssueOperations:function(e){this.getView().getModel("idOperationInProgressTable").setProperty("/showOnlyHoldIssues",true);this._bButtonItemClicked=false;this.getSearchTableCount(this._searchField.getValue(),this.getView().getBindingContext(),this.getView().getModel());},showAllRdyToFnshIssuesOperations:function(e){this.getView().getModel("idOperationInProgressTable").setProperty("/showOnlyHoldIssues",false);this.getView().getModel("idOperationInProgressTable").setProperty("/showOnlyRdyToFnshIssues",true);this._bButtonItemClicked=false;this.getSearchTableCount(this._searchField.getValue(),this.getView().getBindingContext(),this.getView().getModel());}});});
