/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/i2d/mpe/lib/commons1/utils/formatter","sap/ui/core/format/NumberFormat","sap/i2d/mpe/lib/popovers1/fragments/MaterialController","sap/i2d/mpe/lib/popovers1/fragments/ProductionOrderController","sap/i2d/mpe/lib/popovers1/fragments/ProductionOrderOperationsController","sap/ui/model/resource/ResourceModel","sap/i2d/mpe/lib/commons1/utils/util","sap/i2d/mpe/lib/commons1/fragments/OrderOperationStatus","sap/i2d/mpe/lib/commons1/utils/NavHelper","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(C,F,N,M,P,O,R,r,b,c,d,e,J,f){"use strict";return C.extend("i2d.mpe.operations.manages1.blocks.OperationNotStartedController",{formatter:F,reuseUtil:r,onInit:function(){this.oMaterialPop=new M();this.oProductionOrderPop=new P();this.oOperationPop=new O();var i=this.loadI18NFile();this.getView().setModel(i,"common_i18n");this.getView().byId("idOperationNotStartedTable").setIgnoreFromPersonalisation("ManufacturingOrder,ManufacturingOrderSequence,ManufacturingOrderOperation,Material,MaterialName,MfgOrderOperationText,OpPlannedTotalQuantity,OperationUnit,OpLtstSchedldExecStrtDte,OpLtstSchedldExecEndDte,OpActualExecutionStartDate,OpActualExecutionEndDate,OpPlannedScrapQuantity,OperationYieldDeviationQty,OperationHasScrapQualityIssue,ExecutionEndLatenessInHours,ExecutionEndLatenessInMinutes,ExecutionStartLatenessInHours,ExecutionStartLatenessInMins,OpExecutionCompletedQuantity,OpHasAssgdProdnRsceTools,OperationHasMissingComponents,OperationHasProductionHold,OperationIsClosed,OperationIsConfirmed,OperationIsCreated,OperationIsDeleted,OperationIsDelivered,OperationIsPartiallyConfirmed,OperationIsPartiallyDelivered,OperationIsPrinted,OperationIsReleased,OperationIsScheduled,OperationIsTechlyCompleted,OperationStartDeviationDays,OperationStatusInternalID,PlannedEndDateDvtnInDays,WorkCenterTypeCode");var v;v=new J({allIssuesCount:0,showOnlyReleasedIssues:false,showOnlyRdyToStrtIssues:false});this.getView().setModel(v,"idOperationNotStartedTable");this.oViewModel=this.getView().getModel("idOperationNotStartedTable");this._bButtonItemClicked=true;},loadI18NFile:function(){var i=jQuery.sap.getModulePath("sap.i2d.mpe.lib.commons1")+"/"+"i18n/i18n.properties";return new R({bundleUrl:i});},onBeforeRendering:function(){},getTableCount:function(w,p,q){var E="/C_Manageoperations/$count";var s=new sap.ui.model.Filter({and:false,filters:[new e("ManufacturingOrder",d.Contains,q),new e("Material",d.Contains,q),new e("MaterialName",d.Contains,q)]});var o=this.getAllOperationFilter();var a=this.getAllOperationReadyFilter();var g=this.getAllOperationReleaseFilter();var W=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("WorkCenterInternalID",sap.ui.model.FilterOperator.EQ,w),new sap.ui.model.Filter("ProductionPlant",sap.ui.model.FilterOperator.EQ,p)]});var m={filters:[new sap.ui.model.Filter({and:true,filters:[o,W,s]})],success:function(D){var v=new J({oDataCount3:D});this.getView().setModel(v,"view2");var t=this.getView().byId("idOperationNotStartedFirstTable");t.setBusy(false);}.bind(this),error:function(j){sap.m.MessageBox.error(j);}};this.getView().getModel().read(E,m);var h={filters:[new sap.ui.model.Filter({and:true,filters:[g,W,s]})],success:function(D){var v=new J({oDataCount:D});this.getView().setModel(v,"view1");var t=this.getView().byId("idOperationNotStartedFirstTable");t.setBusy(false);}.bind(this),error:function(j){sap.m.MessageBox.error(j);}};this.getView().getModel().read(E,h);var i={filters:[new sap.ui.model.Filter({and:true,filters:[a,W,s]})],success:function(D){var v=new J({oDataCount2:D});this.getView().setModel(v,"view");var t=this.getView().byId("idOperationNotStartedFirstTable");t.setBusy(false);}.bind(this),error:function(j){sap.m.MessageBox.error(j);}};this.getView().getModel().read(E,i);},handleCoverageChartPress:function(E){var o=E.getSource().getBindingContext();var m=o.getModel();var s=m.getContext(o.getPath()).getObject();var q=[];var Q=[];var a=[];var g=s.OpTotalConfirmedYieldQty;var u=s.OperationUnit;if(g!==undefined&&g>=0){g=N.getFloatInstance({}).format(g);q.push(g);Q.push("grey");var p=this.getView().getModel("common_i18n").getResourceBundle().getText("processed");a.push(p);}var h=s.MfgOrderOperationReadyQuantity;var i=this.getView().getModel("common_i18n").getResourceBundle().getText("ready");if(h!==undefined&&h>=0){h=N.getFloatInstance({}).format(h);q.push(h);Q.push("green");a.push(i);}else if((h!==undefined&&h<0)){h=N.getFloatInstance({}).format(0);q.push(h);Q.push("green");a.push(i);}var j=s.MfgOrderOperationNotReadyQty;var n=this.getView().getModel("common_i18n").getResourceBundle().getText("notReady");if(j!==undefined&&j>=0){j=N.getFloatInstance({}).format(j);q.push(j);Q.push("orange");a.push(n);}else if((j!==undefined&&j<0)){j=N.getFloatInstance({}).format(0);q.push(j);Q.push("orange");a.push(n);}r.openStackedBarChartPopover2(this,E,q,Q,a,u);},getOperationIdFromGlobalTransportModel:function(){var m=this.getView().getModel("DetailModel");var o=m.getData();this.OrderId=o.orderId;var a=o.WorkCenter;},handleBeforeRebindTable:function(E){var B=E.getSource().getBindingContext();var q=this.getView().byId("idSearchField").getValue();var p;if(B){p=B.getPath();}else{p="/"+this.getView().getModel("DetailModel").getData().orderId;}var o=E.getSource().getModel().getContext(p).getObject();var a=this.getView().getModel("DetailModel").getData();if(!o&&o===undefined&&a.selectedOrderData){o=a.selectedOrderData;}var g=new sap.ui.model.Filter([],true);var m=E.getParameter("bindingParams");m.sorter=[new sap.ui.model.Sorter("OpLtstSchedldExecStrtDte")];var t=m.filters;var s=new sap.ui.model.Filter({and:false,filters:[new e("ManufacturingOrder",d.Contains,q),new e("Material",d.Contains,q),new e("MaterialName",d.Contains,q)]});var h=this.getAllOperationFilter();var w=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("WorkCenterInternalID",sap.ui.model.FilterOperator.EQ,o.WorkCenterInternalID),new sap.ui.model.Filter("ProductionPlant",sap.ui.model.FilterOperator.EQ,o.ProductionPlant)]});if(this.returnRelStatusValue(E)===true){var i=this.getAllOperationReleaseFilter();}else if(this.returnAllRdyToStrtStatusValue(E)===true){var j=this.getAllOperationReadyFilter();}if(this.returnRelStatusValue(E)===true){g.aFilters.push(h,w,i,s);t.push(g);}else if(this.returnAllRdyToStrtStatusValue(E)===true){g.aFilters.push(h,w,j,s);t.push(g);}else{g.aFilters.push(h,w,s);t.push(g);}if(this._bButtonItemClicked===true){}else{this._bButtonItemClicked=true;}},returnRelStatusValue:function(E){var i=this.getView().getModel("idOperationNotStartedTable");var I=i.getData();return I.showOnlyReleasedIssues;},returnAllRdyToStrtStatusValue:function(E){var i=this.getView().getModel("idOperationNotStartedTable");var I=i.getData();return I.showOnlyRdyToStrtIssues;},showAllOperations:function(E){this.getView().getModel("idOperationNotStartedTable").setProperty("/showOnlyReleasedIssues",false);this.getView().getModel("idOperationNotStartedTable").setProperty("/showOnlyRdyToStrtIssues",false);this._bButtonItemClicked=false;this.getSearchTableCount(this.getView().byId("idSearchField").getValue(),this.getView().getBindingContext(),this.getView().getModel());},showAllReleasedOperations:function(E){this.getView().getModel("idOperationNotStartedTable").setProperty("/showOnlyReleasedIssues",true);this._bButtonItemClicked=false;this.getSearchTableCount(this.getView().byId("idSearchField").getValue(),this.getView().getBindingContext(),this.getView().getModel());},showAllRdyToStrtIssuesOperations:function(E){this.getView().getModel("idOperationNotStartedTable").setProperty("/showOnlyReleasedIssues",false);this.getView().getModel("idOperationNotStartedTable").setProperty("/showOnlyRdyToStrtIssues",true);this._bButtonItemClicked=false;this.getSearchTableCount(this.getView().byId("idSearchField").getValue(),this.getView().getBindingContext(),this.getView().getModel());},handleOperationsBtnPress:function(){this.goAllOpTable=this.getView().byId("idOperationNotStartedTable");this.goAllOpTable.rebindTable();},handleSegmntBtnPress:function(){this.oSmartTable=this.getView().byId("idOperationNotStartedTable");this.oSmartTable.rebindTable();},handleIconPress:function(E){var o=E.getSource().getColor();if(o==="#d9d9d9"){return"";}else{var w=true;r.openIssuePopOver(E,this,w);}},handleMaterialLinkPress:function(E){var o=E.getSource().getBindingContext();var m=o.getModel();var p=m.getProperty("ProductionPlant",o);var s=m.getProperty("Material",o);this.oMaterialPop.openMaterialPopOver(E,this,s,p);},handleOrderNumberPress:function(E){var s=E.getSource();var p=s.getBindingContext().sPath;var o=s.getModel().getProperty(p);var m=o.ManufacturingOrder||o.MRPElement;this.oProductionOrderPop.openProdOrdPopOver(E,this,m);},handleOperationPress:function(E){var o=E.getSource().getBindingContext();var m=o.getModel();var s=m.getProperty("OrderInternalID",o);var a=m.getProperty("OrderOperationInternalID",o);this.oOperationPop.openOperationsPopOver(E,this,s,a);},handleOperationSelect:function(E){var p=E.getParameter("listItem").getBindingContextPath();var o=r.getObjectPageRefrence();if(o&&o.getRouter()){var a=o.getRouter();var A=o.iAppState;a.navTo("object",{operationId:p.substr(1),iAppState:A},false);}else{var g=sap.ushell.Container.getService("CrossApplicationNavigation");g.toExternal({target:{shellHash:"#ManufacturingOrderOperation-manage&/ManageOperations"+p}});}},_filter:function(){var o=null;if(this._oGlobalFilter){o=this._oGlobalFilter;}this.getView().byId("idOperationNotStartedFirstTable").getBinding("items").filter(o,"Application");},handleOrdersSearch:function(E){var B=E.getSource().getBindingContext();var q=E.getParameter("query");this._oGlobalFilter=null;this.getSearchTableCount(q,B,this.getView().getModel());var p=B.getPath();var o=this.getView().getModel().getContext(p).getObject();},getSearchTableCount:function(q,B,D){var m=new sap.ui.model.Filter({and:false,filters:[new e("ManufacturingOrder",d.Contains,q),new e("Material",d.Contains,q),new e("MaterialName",d.Contains,q)]});var o=this.getAllOperationFilter();var a=this.getAllOperationReadyFilter();var g=this.getAllOperationReleaseFilter();var p=B.getPath();var h=D.getContext(p).getObject();var w=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("WorkCenterInternalID",sap.ui.model.FilterOperator.EQ,h.WorkCenterInternalID),new sap.ui.model.Filter("ProductionPlant",sap.ui.model.FilterOperator.EQ,h.ProductionPlant)]});if(this.returnRelStatusValue()===true){this._oGlobalFilter=new e({and:true,filters:[m,g,w]});this._filter();}else if(this.returnAllRdyToStrtStatusValue()===true){this._oGlobalFilter=new e({and:true,filters:[m,a,w]});this._filter();}else{this._oGlobalFilter=new e({and:true,filters:[m,o,w]});this._filter();}},handleStatusLinkPress:function(E){b.openStatusPopOver(E,this);},handleItemSelect:function(E){var p=E.getParameter("listItem").getBindingContextPath();var t=this.getView().byId("idOperationNotStartedFirstTable");t.setBusy(true);var m=this.getView().getModel();var o=m.getProperty(p);var s=o.ManufacturingOrder;var a=o.ManufacturingOrderOperation;var g=o.OperationStatusInternalID;var h=this.getView().getModel("common_i18n").getResourceBundle().getText("messageBoxHeader");var i=this.getView().getModel("common_i18n").getResourceBundle().getText("messageBoxMessage");if(this.getView().getModel("objectView").oData.workCenterQueue){if(g==="01"){sap.m.MessageBox.information(i,{title:h});t.setBusy(false);}else{c.navFromOrderEntry(this,s,a,t);}}else{this.handleOperationSelect(E);}},getAllOperationFilter:function(){var o=new sap.ui.model.Filter({and:false,filters:[new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,1),new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,2),new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,3)]});return o;},getAllOperationReadyFilter:function(){var o=new sap.ui.model.Filter({and:false,filters:[new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,2),new sap.ui.model.Filter("OperationStatusInternalID",sap.ui.model.FilterOperator.EQ,3)]});var a=new sap.ui.model.Filter({and:true,filters:[new sap.ui.model.Filter("OperationHasProductionHold",sap.ui.model.FilterOperator.EQ,false),new sap.ui.model.Filter("OperationHasMissingComponents",sap.ui.model.FilterOperator.NE,'X')]});var g=new sap.ui.model.Filter({and:true,filters:[o,a]});return g;},getAllOperationReleaseFilter:function(){var a=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("OperationIsReleased",sap.ui.model.FilterOperator.EQ,'X')]});var o=this.getAllOperationFilter();var g=new sap.ui.model.Filter({and:true,filters:[o,a]});return g;}});});
