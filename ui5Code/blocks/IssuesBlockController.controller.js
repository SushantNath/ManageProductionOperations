/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","i2d/mpe/operations/manages2/model/formatter","sap/ui/model/resource/ResourceModel","sap/i2d/mpe/lib/commons1/fragments/HoldMessageStrip","sap/i2d/mpe/lib/commons1/fragments/ReleaseHoldDialog","sap/i2d/mpe/lib/commons1/utils/formatter","sap/ui/model/json/JSONModel"],function(C,F,f,R,H,a,c,J){"use strict";return C.extend("i2d.mpe.operations.manages2.blocks.IssuesBlockController",{formatter:f,commonsFormatter:c,onInit:function(){var i=this.loadI18NFile();this.getView().setModel(i,"i18nCommon");var e={ReleaseHoldDialog:{Channel:"sap.i2d.mpe.operations.manages2",Event:"onReleaseHoldSuccessfullyApplied",Callback:this.onReleaseHoldSuccessfullyComplete}};var E=sap.ui.getCore().getEventBus();this.setEventBusParameters(E,e.ReleaseHoldDialog.Channel,e.ReleaseHoldDialog.Event);},loadI18NFile:function(){var i=jQuery.sap.getModulePath("sap.i2d.mpe.lib.commons1")+"/"+"i18n/i18n.properties";return new R({bundleUrl:i});},getI18NCommonText:function(i,v){return this.getView().getModel("i18nCommon").getResourceBundle().getText(i,v);},onBeforeRendering:function(){},onAfterRendering:function(){},getCompositeKey:function(O,b){if(O&&b){this.onHandleInitComponentsTable();}},onHandleInitComponentsTable:function(){var m=this.getView().getModel("DetailModel");var o=m.getData();var O=o.orderId;this.OrderInternalBillOfOperations=o.sOrderInternalBillOfOperations;this.OrderIntBillOfOperationsItem=o.sOrderIntBillOfOperationsItem;var p=this.oParentBlock.getModel();var P=this.oParentBlock.getModel().oData[O];var h=this.getView().getModel("HoldModel");this._handleIsuesValue(p,h,P,this);},onPressReleaseHold:function(o){var p=o.getSource().data("ProductionHold");a.initAndOpen(this.getView().getModel("HoldModel"),p);var e=this.getEventBusParameters();var E=sap.ui.getCore().getEventBus();a.setEventBusParameters(E,e.ReleaseHoldDialog.Channel,e.ReleaseHoldDialog.Event);},_handleIsuesValue:function(m,h,p,i){var o=f.getObjectPageLayoutReference();var M=p.ManufacturingOrder;var b=p.ManufacturingOrderSequence;var d=p.ManufacturingOrderOperation;var r=this.oParentBlock.getModel("i18n");var s=this.byId("idMissingComponents");var q=this.byId("idQltyIssue");var Q=this.byId("idQtyIssue");var D=this.byId("idDelay");var e;var g;s.setVisible(false);q.setVisible(false);Q.setVisible(false);D.setVisible(false);q.destroyLink();var j={ManufacturingOrder:p.ManufacturingOrder,ProductionPlant:p.ProductionPlant,Material:p.Material,WorkCenterInternalID:p.WorkCenterInternalID,OrderInternalBillOfOperations:p.OrderInternalBillOfOperations,OrderIntBillOfOperationsItem:p.OrderIntBillOfOperationsItem};var P=f.getFeatureAvailability(p.MfgFeatureIsActiveInAnyPlant);if(P){H.loadHoldsOperation(m,j,this.getView().byId("holdMessages"));}else{var k=this.getView().byId("holdMessages");k.setModel(new J([]),"holds");}if(p.OperationHasMissingComponents){s.setVisible(true);}if(p.OperationHasScrapQualityIssue==="X"){var l=p.OpTotalConfirmedScrapQty;var t=p.OpPlannedTotalQuantity;if(l!==0&&t!==0){var n=Math.round((l/t)*100);}e="X";}if(p.InspHasRejectedCharc==="X"||p.InspHasRejectedInspSubset==="X"||p.InspHasRejectedInspLot==="X"){var I=this.getI18NCommonText("ConcatWithHyphen",[p.InspectionLot,p.ManufacturingOrderOperation]);var u=[I];var v=new sap.m.Link({text:u,press:function(){var S=o.getSections();if(S&&S.length>1){o.scrollToSection(o.getSections()[5].getId());}}});g="X";}if(e==="X"){if(g==="X"){q.setVisible(true);q.setLink(v);q.setText(this.getI18NCommonText("OpQualityDeviationScrapAndQM",[n]));}else{q.setVisible(true);q.setText(this.getI18NCommonText("QualityDeviationScrap",[n]));}}else{if(g==="X"){q.setVisible(true);q.setLink(v);q.setText(this.getI18NCommonText("OpQualityDeviationQM"));}}if(p.OperationYieldDeviationQty<0){var w=p.MissingQuantity;var x=p.OperationUnit;Q.setVisible(true);Q.setText(r.getProperty("QuantityDeviation")+" : "+w+" "+x);}if(p.OperationExecutionEndIsLate||p.OperationExecutionStartIsLate){var O=p.ExecutionEndLatenessInMinutes;var y=p.ExecutionStartLatenessInMins;var z=Math.round(O);var A=Math.round(y);if(z>A){var B=z;}else{B=A;}B=B/(24*60)+":"+B/60%24+":"+B%60;if(parseInt(B.split(":")[0])!==0){var E=parseInt(B.split(":")[0])+r.getProperty("Days");}else{E="";}if(parseInt(B.split(":")[1])!==0){var G=parseInt(B.split(":")[1])+r.getProperty("Hours");}else{G="";}if(parseInt(B.split(":")[2])!==0){var K=parseInt(B.split(":")[2])+r.getProperty("Minutes");}else{K="";}D.setVisible(true);D.setText(r.getProperty("OPerationDelayed")+" "+E+" "+G+" "+K);}},setEventBusParameters:function(e,E,s){this.oEventBus=e;this.sDialogEventChannel=E;this.sEventId=s;},getEventBusParameters:function(){var e={ReleaseHoldDialog:{Channel:"sap.i2d.mpe.operations.manages2",Event:"onHoldSuccessfullyApplied",Callback:this._onReleaseHoldSuccessfullyComplete}};return e;},_onReleaseHoldSuccessfullyComplete:function(s,e,r){if(r.success){if(this.oEventBus){var S={success:true};}this.oEventBus.publish(this.sDialogEventChannel,this.sEventId,r);}else{}}});});
